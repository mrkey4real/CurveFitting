'''
1. Cooling Mode High-stage Curve-fitting Results:
Rated total cooling capacity [W]: 8000.840216
Rated sensible heat ratio [1]: 0.82
Rated cooling COP [1]: 2.83718
Rated air flow rate [m3/s]: 0.54746
Fitted coefficients for Power:
 a = 1781.7247287163993, b = -37.578542761462764, c = 1.058147020112969, d = 19.946071290728355, e = 0.5519571264769484, f = 0.003151249713088813
Fitted coefficients for Capacity:
 a = 11343.398506278794, b = -410.40305337597385, c = 14.301628694666203, d = 40.98724406868598, e = -1.5294540873709077, f = 0.006195062754993499
R-squared for Power: 0.9997935477919369
CVRMSE for Power: 0.27931369329728106%
R-squared for Capacity: 0.9817820852142595
CVRMSE for Capacity: 1.0241595641759904%

2. Cooling Mode Medium-stage Curve-fitting Results:
Rated total cooling capacity [W]: 7854.304681
Rated sensible heat ratio [1]: 0.78
Rated cooling COP [1]: 2.79513
Rated air flow rate [m3/s]: 0.47667
Fitted coefficients for Power:
 a = 1062.9633274704456, b = 14.352591226576921, c = 0.053217787988528255, d = 32.59346856064092, e = 0.4748142691627527, f = -0.38054202480914834
Fitted coefficients for Capacity:
 a = 8979.37566235307, b = -252.78405828885894, c = 11.32617545740223, d = 83.84366553846759, e = -1.7996238338050095, f = -1.271719666473188
R-squared for Power: 0.9986922136712102
CVRMSE for Power: 0.7166109818792785%
R-squared for Capacity: 0.9731331629239562
CVRMSE for Capacity: 1.2619220455342675%

3. Cooling Mode Low-stage Curve-fitting Results:
Rated total cooling capacity [W]: 7737.076252
Rated sensible heat ratio [1]: 0.7
Rated cooling COP [1]: 2.76324
Rated air flow rate [m3/s]: 0.40587
Fitted coefficients for Power:
 a = 181.7210370064003, b = 54.969256567585894, c = -0.33818232391206304, d = 59.87840473744909, e = 0.27192845679275857, f = -1.0674645282615143
Fitted coefficients for Capacity:
 a = 6873.818981437037, b = -180.2457132305299, c = 11.172132473008375, d = 155.65230035418446, e = -2.354658567052916, f = -2.992007739937055
R-squared for Power: 0.9951485115973626
CVRMSE for Power: 1.4400494685447065%
R-squared for Capacity: 0.9494199130440327
CVRMSE for Capacity: 1.7589057819864176%

#######################################################################

1. Cooling Mode High-stage Curve-fitting Results:
Rated total cooling capacity [W]: 8000.840216
Rated sensible heat ratio [1]: 0.82
Rated cooling COP [1]: 2.83718
Rated air flow rate [m3/s]: 0.54746
Rated cooling EIR [1]: 0.352463
Fitted coefficients for EIR:
 a = 0.6318208474484364, b = -0.013325926937484175, c = 0.0003752312237212617, d = 0.007072967431585461, e = 0.00019572996721917168, f = 1.1216065591233756e-06
Fitted coefficients for Capacity:
 a = 1.4177739880934142, b = -0.05129488795686658, c = 0.0017875157549395637, d = 0.00512292705398193, e = -0.00019116171085283414, f = 7.711079587695833e-07
R-squared for Power: 0.9997935477918349
CVRMSE for Power: 0.2793136933662834%
R-squared for Capacity: 0.9817820852153644
CVRMSE for Capacity: 1.0241595641449335%

2. Cooling Mode Medium-stage Curve-fitting Results:
Rated total cooling capacity [W]: 7854.304681
Rated sensible heat ratio [1]: 0.78
Rated cooling COP [1]: 2.79513
Rated air flow rate [m3/s]: 0.47667
Rated cooling EIR [1]: 0.357765
Fitted coefficients for EIR:
 a = 0.14455352032730673, b = 0.04912627056769825, c = -0.001259328740984333, d = 4.4832735199269554e-05, e = 0.0005466272707686866, f = -0.00048324142048419085
Fitted coefficients for Capacity:
 a = 1.1432426540402085, b = -0.032184141303762286, c = 0.0014420339900066566, d = 0.010674863725722914, e = -0.00022912577211369332, f = -0.00016191357873546612
R-squared for EIR: 0.9984532330418099
CVRMSE for EIR: 1.0653045382994266%
R-squared for Capacity: 0.9731331629239556
CVRMSE for Capacity: 1.2619220455342834%

3. Cooling Mode Low-stage Curve-fitting Results:
Rated total cooling capacity [W]: 7737.076252
Rated sensible heat ratio [1]: 0.7
Rated cooling COP [1]: 2.76324
Rated air flow rate [m3/s]: 0.40587
Rated cooling EIR [1]: 0.361894
Fitted coefficients for EIR:
 a = -0.014706306778686878, b = 0.05913859677553686, c = -0.0014236348569922805, d = 0.0036841257556882432, e = 0.0005289223545554958, f = -0.0005975696343917768
Fitted coefficients for Capacity:
 a = 0.8884259118138694, b = -0.023296358944769044, c = 0.0014439733747069583, d = 0.02011771472708462, e = -0.000304334406531005, f = -0.0003867103594679912
R-squared for EIR: 0.9982575283290748
CVRMSE for EIR: 1.1502143081512044%
R-squared for Capacity: 0.9494199130440323
CVRMSE for Capacity: 1.7589057819864258%

4.Heating Mode Boost
Rated heating capacity [W]: 8909.360533
Rated heating COP [1]: 3.04
Rated air flow rate [m3/s]: 0.47194745
Rated heating EIR [1]: 0.328947
Fitted coefficients for EIR:
 a = 1.129962327798133, b = -0.014449469293327563, c = 0.0004896785544375052, d = -2.6451518006127133e-05
Fitted coefficients for Capacity:
 a = 0.8393532404178623, b = 0.01730058719562078, c = 0.00014067873708805968, d = 1.2542808218919748e-05
R-squared for EIR: 0.992921347775996
CVRMSE for EIR: 2.1684959926105285%
R-squared for Capacity: 0.9968323332634121
CVRMSE for Capacity: 1.7686613212387126%

5.Heating Mode Normal
Rated heating capacity [W]: 8440.446821
Rated heating COP [1]: 3.20
Rated air flow rate [m3/s]: 0.47194745
Rated heating EIR [1]: 0.3125
Fitted coefficients for EIR:
 a = 1.172812327021518, b = -0.01809442096558878, c = 0.0004486347052133557, d = -2.620130481131559e-05
Fitted coefficients for Capacity:
 a = 0.866852289356436, b = 0.015155784353840773, c = 0.00010020921442626803, d = 1.5992504938311292e-05
R-squared for EIR: 0.9904646016688426
CVRMSE for EIR: 2.7201122925375687%
R-squared for Capacity: 0.9919321643494693
CVRMSE for Capacity: 2.6379868445114916%
'''
import numpy as np
from scipy.optimize import curve_fit
import pandas as pd
import matplotlib.pyplot as plt

# Define the biquadratic function
def biquadratic(X, a, b, c, d, e, f):
    Twb, Tdb = X
    return a + b * Twb + c * Twb**2 + d * Tdb + e * Tdb**2 + f * Twb * Tdb

def cubic(Tdb, a, b, c, d):
    return a + b * Tdb + c * Tdb**2 + d * Tdb**3
# Load data
# sheet_name = 'heating_boost'
ref_cap = 7854.304681
ref_EIR = 0.357765
sheet_name = 'heating_boost'
# sheet_name = 'cooling_low'
data = pd.read_excel("heating_mode.xlsx", sheet_name=sheet_name)

# Extract input variables
Twb = data['iat_C'].values # indoor air wet-bulb temperature
Tdb = data['oat_C'].values # outdoor air dry-bulb temperature

# Extract output variables
EIR = data['EIR'].values
EIR = EIR/ref_EIR
Capacity = data['Capacity_W'].values
Capacity = Capacity/ref_cap

# Perform curve fitting for Power
popt_EIR, pcov_EIR = curve_fit(cubic, Tdb, EIR)
# popt_EIR, pcov_EIR = curve_fit(biquadratic, (Twb,Tdb), EIR)
# a1, b1, c1, d1, e1, f1 = popt_EIR
# print(f"Fitted coefficients for EIR:\n a = {a1}, b = {b1}, c = {c1}, d = {d1}, e = {e1}, f = {f1}")
a1, b1, c1, d1= popt_EIR
print(f"Fitted coefficients for EIR:\n a = {a1}, b = {b1}, c = {c1}, d = {d1}")
# Perform curve fitting for Capacity
popt_capacity, pcov_capacity = curve_fit(cubic, Tdb, Capacity)
# popt_capacity, pcov_capacity = curve_fit(biquadratic, (Twb,Tdb), Capacity)
# a2, b2, c2, d2, e2, f2 = popt_capacity
# print(f"Fitted coefficients for Capacity:\n a = {a2}, b = {b2}, c = {c2}, d = {d2}, e = {e2}, f = {f2}")
a2, b2, c2, d2 = popt_capacity
print(f"Fitted coefficients for Capacity:\n a = {a2}, b = {b2}, c = {c2}, d = {d2}")
#%%
# Make predictions for both Power and Capacity
predicted_EIR = cubic(Tdb, *popt_EIR)
predicted_capacity = cubic(Tdb, *popt_capacity)
# predicted_EIR = biquadratic((Twb,Tdb), *popt_EIR)
# predicted_capacity = biquadratic((Twb,Tdb), *popt_capacity)
# Calculate goodness of fit (R-squared) and CVRMSE for Power
residuals_EIR = EIR - predicted_EIR
ss_res_EIR = np.sum(residuals_EIR**2)
ss_tot_EIR = np.sum((EIR - np.mean(EIR))**2)
r_squared_EIR = 1 - (ss_res_EIR / ss_tot_EIR)
rmse_EIR = np.sqrt(ss_res_EIR / len(EIR))
cvrmse_EIR = (rmse_EIR / np.mean(EIR)) * 100
print(f"R-squared for EIR: {r_squared_EIR}")
print(f"CVRMSE for EIR: {cvrmse_EIR}%")

# Calculate goodness of fit (R-squared) and CVRMSE for Capacity
residuals_capacity = Capacity - predicted_capacity
ss_res_capacity = np.sum(residuals_capacity**2)
ss_tot_capacity = np.sum((Capacity - np.mean(Capacity))**2)
r_squared_capacity = 1 - (ss_res_capacity / ss_tot_capacity)
rmse_capacity = np.sqrt(ss_res_capacity / len(Capacity))
cvrmse_capacity = (rmse_capacity / np.mean(Capacity)) * 100
print(f"R-squared for Capacity: {r_squared_capacity}")
print(f"CVRMSE for Capacity: {cvrmse_capacity}%")

# # Save predictions to a CSV
# data['Predicted EIR'] = predicted_EIR
# data['Predicted Capacity'] = predicted_capacity
# data.to_csv('fitted_results.csv', index=False)
# print("Fitted results saved to 'fitted_results.csv'")

# Plotting scatter
fig, axs = plt.subplots(1, 2, figsize=(10, 5))

# Subplot 1: Measured vs. Predicted EIR
axs[0].scatter(EIR, predicted_EIR, color='blue', alpha=0.7, label='Data points')
axs[0].plot([EIR.min(), EIR.max()], [EIR.min(), EIR.max()], 'r--', label='Ideal fit (y=x)')
# # Calculate ±15% deviation bounds (filled) for EIR
# lower_bound_EIR = EIR * 0.85
# upper_bound_EIR = EIR * 1.15
# axs[0].fill_between(EIR, lower_bound_EIR, upper_bound_EIR, color='gray', alpha=0.2, label='±15% Deviation')
# Calculate ±15% deviation bounds for EIR
axs[0].plot([EIR.min(), EIR.max()], [EIR.min() * 0.85, EIR.max() * 0.85], 'b--', label='±15% Deviation')
axs[0].plot([EIR.min(), EIR.max()], [EIR.min() * 1.15, EIR.max() * 1.15], 'b--')
axs[0].set_title('Measured vs. Predicted EIR')
axs[0].set_xlabel('Measured EIR')
axs[0].set_ylabel('Predicted EIR')
axs[0].set_xlim(min(EIR.min(), predicted_EIR.min()),max(EIR.max(), predicted_EIR.max()))
axs[0].set_ylim(min(EIR.min(), predicted_EIR.min()),max(EIR.max(), predicted_EIR.max()))
axs[0].legend(loc='lower right')
axs[0].grid()

# Subplot 2: Measured vs. Predicted Capacity
axs[1].scatter(Capacity, predicted_capacity, color='green', alpha=0.7, label='Data points')
axs[1].plot([Capacity.min(), Capacity.max()], [Capacity.min(), Capacity.max()], 'r--', label='Ideal fit (y=x)')
##Calculate ±15% deviation bounds (filled) for Capacity
#lower_bound_capacity = Capacity * 0.85
#upper_bound_capacity = Capacity * 1.15
#axs[1].fill_between(Capacity, lower_bound_capacity, upper_bound_capacity, color='gray', alpha=0.2, label='±15% Deviation')
# Calculate ±15% deviation bounds for Capacity
axs[1].plot([Capacity.min(), Capacity.max()], [Capacity.min() * 0.85, Capacity.max() * 0.85], 'g--', label='±15% Deviation')
axs[1].plot([Capacity.min(), Capacity.max()], [Capacity.min() * 1.15, Capacity.max() * 1.15], 'g--')
axs[1].set_title('Measured vs. Predicted Capacity')
axs[1].set_xlabel('Measured Capacity')
axs[1].set_ylabel('Predicted Capacity')
axs[1].set_xlim(min(Capacity.min(), predicted_capacity.min()),max(Capacity.max(), predicted_capacity.max()))
axs[1].set_ylim(min(Capacity.min(), predicted_capacity.min()),max(Capacity.max(), predicted_capacity.max()))
axs[1].legend(loc='lower right')
axs[1].grid()

# Adjust layout and show plot
plt.tight_layout()
plt.savefig(sheet_name+"_scatter_plot.png")
plt.show()

# Plotting
fig, axs = plt.subplots(2, 1, figsize=(10, 5))

# Subplot 1: Measured vs. Predicted EIR
x_points = np.arange(len(EIR))  # Number of data points
axs[0].plot(x_points, EIR, label='Measured EIR', color='blue', linewidth=2)
axs[0].plot(x_points, predicted_EIR, label='Predicted EIR', color='red', linestyle='--', linewidth=2)
axs[0].set_title('Measured vs. Predicted EIR')
axs[0].set_xlabel('Data Point Index')
axs[0].set_ylabel('EIR')
axs[0].legend(loc='lower right')
axs[0].grid()

# Subplot 2: Measured vs. Predicted Capacity
axs[1].plot(x_points, Capacity, label='Measured Capacity', color='blue', linewidth=2)
axs[1].plot(x_points, predicted_capacity, label='Predicted Capacity', color='red', linestyle='--', linewidth=2)
axs[1].set_title('Measured vs. Predicted Capacity')
axs[1].set_xlabel('Data Point Index')
axs[1].set_ylabel('Capacity')
axs[1].legend(loc='lower right')
axs[1].grid()

# Adjust layout and show plot
plt.tight_layout()
plt.savefig(sheet_name+"_model_accuracy.png")
plt.show()
